<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyCap NYC — Affitti ≤ $3.000</title>
  <meta name="description" content="KeyCap NYC: affitti a Manhattan, Brooklyn e Queens entro $3.000. Filtri rapidi, ZIP, Strict mode, Lease Takeover e Direct to Owner." />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    html,body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    :root{
      --bg: #0b0c10; --fg: #f7f8fa; --surface: #11151c; --muted: #9aa3ae;
      --border: rgba(255,255,255,.10); --accent: #16a34a; --accent-700: #15803d;
      --warn-bg: rgba(234,179,8,.12); --warn-br: rgba(234,179,8,.35); --warn-fg: #eab308;
    }
    body{ background: var(--bg); color: var(--fg); }
    .bg-surface{ background: var(--surface); }
    .text-muted{ color: var(--muted); }
    .border-muted{ border-color: var(--border); }
    .card{ transition: transform .15s ease, box-shadow .15s ease; }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.14); }
    .zip-active{ background: var(--accent) !important; color:#fff !important; border-color: var(--accent) !important; }
    .beds-btn{
      padding: .35rem .6rem; font-size: .85rem; border-radius: .6rem;
      border: 1px solid var(--border); background: var(--surface); color: var(--fg);
      font-weight: 700; transition: background .15s, color .15s, border-color .15s;
    }
    .beds-btn:hover{ background: rgba(22,163,74,.10); border-color: var(--accent); }
    .beds-active{ background: var(--accent) !important; color:#fff !important; border-color: var(--accent) !important; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type="checkbox"]{ accent-color: var(--accent); }
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto p-6">

    <!-- Header -->
    <header class="flex items-center gap-3 py-4 border-b border-muted mb-6">
      <svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg" class="rounded-xl">
        <rect width="44" height="44" rx="10" fill="#16a34a"/>
        <text x="50%" y="50%" text-anchor="middle" dy=".35em"
              font-size="22" font-family="Inter, sans-serif" font-weight="700" fill="white">K</text>
      </svg>
      <div class="min-w-0">
        <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-none">
          KeyCap <span class="text-[#16a34a]">NYC</span>
        </h1>
        <p class="text-sm text-muted mt-1">
          Affitti a <span id="areaLabel">Manhattan</span> ≤ <span id="maxRentLabel">$3,000</span>
        </p>
      </div>
    </header>

    <!-- Avviso -->
    <section class="mt-1 mb-5">
      <div class="rounded-xl px-4 py-3 text-sm border border-[var(--warn-br)] bg-[var(--warn-bg)] text-[var(--warn-fg)]">
        ⚠️ StreetEasy e Zillow possono mostrare annunci sponsorizzati o “net effective” sopra soglia. Usa <strong>Strict</strong> per risultati garantiti (Craigslist).
      </div>
    </section>

    <!-- Controlli -->
    <section class="grid md:grid-cols-5 gap-3 items-end mb-6">
      <div>
        <label class="block text-sm font-semibold mb-1" for="area">Area</label>
        <select id="area" class="w-full border border-muted rounded-2xl p-3 bg-surface">
          <option value="manhattan" selected>Manhattan</option>
          <option value="harlem">Harlem</option>
          <option value="upper_manhattan">Upper Manhattan</option>
          <option value="brooklyn">Brooklyn</option>
          <option value="queens">Queens</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1" for="maxRent">Budget ($)</label>
        <input id="maxRent" type="number" value="3000" min="800" step="50"
               class="w-full border border-muted rounded-2xl p-3 bg-surface" />
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Letti min</label>
        <div id="bedsSeg" class="flex flex-wrap gap-2">
          <button type="button" data-beds=""  class="beds-btn beds-active">Qualsiasi</button>
          <button type="button" data-beds="0" class="beds-btn">Studio</button>
          <button type="button" data-beds="1" class="beds-btn">1+</button>
          <button type="button" data-beds="2" class="beds-btn">2+</button>
          <button type="button" data-beds="3" class="beds-btn">3+</button>
        </div>
        <input id="bedsMin" type="hidden" value="">
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1" for="zip">ZIP (opz.)</label>
        <input id="zip" placeholder="es. 10009 o 11211" class="w-full border border-muted rounded-2xl p-3 bg-surface" />
      </div>

      <div class="flex flex-wrap gap-2 justify-end items-center">
        <button id="build" class="px-4 py-2 rounded-xl border border-muted bg-white/90 text-black text-sm">Genera link</button>
        <button id="strict" class="px-4 py-2 rounded-xl bg-[var(--accent)] hover:bg-[var(--accent-700)] text-white text-sm">Strict ≤$3k</button>
        <button id="reset" class="px-4 py-2 rounded-xl border border-muted bg-surface text-sm">Reset</button>
        <label class="flex items-center gap-2 text-sm font-semibold">
          <input id="noFee" type="checkbox" class="w-5 h-5" />
          No-fee
        </label>
        <label class="flex items-center gap-2 text-sm font-semibold" title="Subentro: assignment/takeover/break">
          <input id="leaseTakeover" type="checkbox" class="w-5 h-5" />
          Lease takeover
        </label>
        <label class="flex items-center gap-2 text-sm font-semibold" title="Annunci diretti (esclude sublet/room/short-term)">
          <input id="directOwner" type="checkbox" class="w-5 h-5" />
          Direct to owner
        </label>
      </div>
    </section>

    <!-- ZIP Pills -->
    <section class="mt-2 mb-2">
      <h2 class="text-lg font-semibold mb-3">ZIP rapidi (<span id="zipAreaLabel">Manhattan</span>)</h2>
      <div id="zipPills" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2 mt-1 text-sm"></div>
    </section>

    <!-- Provider cards -->
    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="providers"></section>

    <!-- Strict -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Strict (Craigslist) ≤ $3.000</h2>
      <div id="strictBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p class="text-xs text-muted mt-2" id="strictNote">
        Strict attivo per Manhattan, Brooklyn e Queens (Harlem/Upper Manhattan = Manhattan).
      </p>
    </section>

    <footer class="mt-12 text-xs text-muted">
      <p>Questa pagina apre ricerche pubbliche con parametri nell'URL. I portali possono cambiare i parametri nel tempo.</p>
    </footer>
  </main>

  <script>
    // ===== ZIPS PER AREA =====
    const ZIPS = {
      manhattan: [
        '10001','10002','10003','10004','10005','10006','10007','10009','10010','10011','10012','10013','10014',
        '10016','10017','10018','10019','10021','10022','10023','10024','10025','10026','10027','10028','10029',
        '10030','10031','10032','10033','10034','10035','10036','10037','10038','10039','10040','10044','10065','10069','10075','10280','10282'
      ],
      harlem: [ '10026','10027','10030','10031','10032','10037','10039' ],
      upper_manhattan: [ '10026','10027','10028','10029','10030','10031','10032','10033','10034','10035','10036','10037','10039','10040' ],
      brooklyn: [
        '11201','11203','11204','11205','11206','11207','11208','11209','11210','11211','11212','11213','11214','11215','11216','11217',
        '11218','11219','11220','11221','11222','11223','11224','11225','11226','11228','11229','11230','11231','11232','11233','11234',
        '11235','11236','11237','11238','11239'
      ],
      queens: [
        '11101','11102','11103','11104','11105','11106',
        '11354','11355','11356','11357','11358','11360','11361','11362','11363','11364','11365','11366','11367',
        '11368','11369','11370','11372','11373','11374','11375','11377','11378','11379','11385',
        '11411','11412','11413','11414','11415','11416','11417','11418','11419','11420','11421','11422','11423','11426','11427','11428','11429','11432','11433','11434','11435','11436',
        '11691','11692','11693','11694','11697'
      ]
    };

    // ===== Helpers =====
    function buildQueryTerms(leaseTakeover, directOwner){
      const takeover = leaseTakeover
        ? '(lease assignment OR lease takeover OR lease break OR assume lease OR landlord approval)'
        : '';
      const directPos = directOwner
        ? '(direct to owner OR owner managed OR management OR leasing office OR no broker OR apply through management OR sponsor unit)'
        : '';
      const directNeg = directOwner
        ? '(-sublet -room -roommate -short-term -temporary -share)'
        : '';
      return [takeover, directPos, directNeg].filter(Boolean).join(' ');
    }

    function getAreaSlugs(area){
      const seArea = (area==='brooklyn'||area==='queens') ? area : 'manhattan';
      const zlAreaMap = { manhattan: 'manhattan-new-york-ny', brooklyn: 'brooklyn-new-york-ny', queens: 'queens-new-york-ny' };
      const zlArea = zlAreaMap[area] || zlAreaMap['manhattan'];
      const clAreaMap = { manhattan: 'mnh', harlem: 'mnh', upper_manhattan: 'mnh', brooklyn: 'brk', queens: 'que' };
      const clArea = clAreaMap[area] || 'mnh';
      const hpAreaMap = { manhattan: 'manhattan-new-york-ny', brooklyn: 'brooklyn-ny', queens: 'queens-ny' };
      const hpArea = hpAreaMap[area] || hpAreaMap['manhattan'];
      return { seArea, zlArea, clArea, hpArea };
    }

    const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // ===== Stato/Label =====
    function readState(){
      const area = document.getElementById('area').value;
      const maxRent = Math.max(0, parseInt(document.getElementById('maxRent').value || '3000', 10));
      const bedsMin = document.getElementById('bedsMin').value;
      const zip = (document.getElementById('zip').value || '').trim();
      const noFee = document.getElementById('noFee').checked;
      const leaseTakeover = document.getElementById('leaseTakeover').checked;
      const directOwner = document.getElementById('directOwner').checked;
      return { area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner };
    }

    function updateLabels(){
      const { area, maxRent } = readState();
      document.getElementById('maxRentLabel').textContent = fmt.format(maxRent);
      const areaName = area === 'upper_manhattan' ? 'Upper Manhattan' : (area.charAt(0).toUpperCase()+area.slice(1)).replace('_',' ');
      document.getElementById('areaLabel').textContent = areaName;
      document.getElementById('zipAreaLabel').textContent = areaName;
    }

    // ===== Beds segmented =====
    (function initBedsSeg(){
      const seg = document.getElementById('bedsSeg');
      const hidden = document.getElementById('bedsMin');
      const setActive = (val)=>{
        hidden.value = val;
        [...seg.querySelectorAll('.beds-btn')].forEach(b=>{
          const on = (b.dataset.beds === val);
          b.classList.toggle('beds-active', on);
          b.setAttribute('aria-pressed', on ? 'true' : 'false');
        });
      };
      seg.addEventListener('click', (e)=>{
        const b = e.target.closest('.beds-btn[data-beds]');
        if (!b) return;
        setActive(b.dataset.beds);
        buildProviderCards();
      });
      setActive(hidden.value || '');
    })();

    // ===== ZIP pills =====
    function renderZipPills(){
      const box = document.getElementById('zipPills');
      const { area } = readState();
      const current = document.getElementById('zip').value;
      box.innerHTML = '';
      (ZIPS[area] || []).forEach(z=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = z;
        btn.className = 'px-3 py-1 rounded-full border border-muted bg-surface text-sm hover:bg-[rgba(22,163,74,.12)]';
        if (current === z) btn.classList.add('zip-active');
        btn.onclick = () => {
          const input = document.getElementById('zip');
          input.value = (input.value === z) ? '' : z;
          renderZipPills();
          buildProviderCards();
        };
        box.appendChild(btn);
      });
    }

    // ===== Provider URLs (HotPads + Craigslist + StreetEasy + Zillow) =====
    function getProviderLinks({ area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner }){
      const enc = encodeURIComponent;
      const bedsParam = bedsMin ? bedsMin : '';
      const { seArea, zlArea, clArea, hpArea } = getAreaSlugs(area);
      const qTerms = buildQueryTerms(leaseTakeover, directOwner);

      // StreetEasy
      let se = `https://streeteasy.com/for-rent/${seArea}?max_price=${maxRent}`;
      if (bedsParam) se += `&beds=${bedsParam}`;
      if (noFee) se += `&no_fee=true`;
      if (zip) se += `&search=zip:${zip}`;
      if (qTerms) se += `&search=${enc(qTerms)}`;

      // Zillow
      let zl = `https://www.zillow.com/${zlArea}/rentals/?price=0-${maxRent}`;
      if (bedsParam) zl += `&beds=${bedsParam}-_`;
      if (zip) zl = `https://www.zillow.com/homes/for_rent/${zip}_rb/?price=0-${maxRent}`;
      if (qTerms && zip) zl += `&text=${enc(qTerms)}`; // best-effort, con ZIP

      // HotPads
      let hp = `https://hotpads.com/${hpArea}/apartments-for-rent?price=-${maxRent}`;
      if (bedsParam) hp += `&beds=${bedsParam}`;
      if (zip) hp = `https://hotpads.com/${zip}/apartments-for-rent?price=-${maxRent}`;
      // (HotPads non offre query testuali affidabili nell’URL, quindi niente qTerms)

      // Craigslist
      const clParams = new URLSearchParams();
      clParams.set('max_price', String(maxRent));
      if (bedsParam) clParams.set('min_bedrooms', String(bedsParam));
      const clQuery = [zip, qTerms].filter(Boolean).join(' ');
      if (clQuery) clParams.set('query', clQuery);
      let cl = `https://newyork.craigslist.org/search/${clArea}/apa?${clParams.toString()}`;

      return [
        { name: 'HotPads',    url: hp },
        { name: area==='manhattan' ? 'Craigslist (Manhattan)' : area==='brooklyn' ? 'Craigslist (Brooklyn)' : 'Craigslist (Queens)', url: cl },
        { name: 'StreetEasy', url: se },
        { name: 'Zillow',     url: zl },
      ];
    }

    function buildProviderCards(){
      const { area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner } = readState();
      const p = document.getElementById('providers');
      p.innerHTML = '';

      const providers = getProviderLinks({ area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner });
      providers.forEach(pr => {
        const a = document.createElement('a');
        a.href = pr.url; a.target = '_blank'; a.rel = 'noopener';
        a.className = 'card block border border-muted rounded-2xl bg-surface p-4';
        a.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${pr.name}</h3>
            <span class="inline-flex items-center gap-1 text-sm text-muted">
              apri
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-70">
                <path d="M7 17L17 7M17 7H9M17 7v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </div>
          <p class="text-sm text-muted">
            Filtri: ${areaLabelText()} · max ${fmt.format(maxRent)}${zip?` · ZIP ${zip}`:''}${bedsMin?` · ${bedsMin}+ letti`:''}${noFee?` · no-fee`:''}${leaseTakeover?` · lease takeover`:''}${directOwner?` · direct owner`:''}
          </p>`;
        p.appendChild(a);
      });

      // share url minimale
      const params = new URLSearchParams();
      params.set('area', area);
      params.set('max', String(maxRent));
      if (bedsMin) params.set('beds', bedsMin);
      if (zip) params.set('zip', zip);
      if (noFee) params.set('nofee', '1');
      if (leaseTakeover) params.set('lt', '1');
      if (directOwner) params.set('do', '1');
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
    }

    function areaLabelText(){
      const val = document.getElementById('area').value;
      return val === 'upper_manhattan' ? 'Upper Manhattan' : (val.charAt(0).toUpperCase()+val.slice(1)).replace('_',' ');
    }

    // ===== Strict (serverless) =====
    // ⚠️ Cambia se il tuo dominio Vercel è diverso
    const API_BASE = 'https://rent-finder-manhattan.vercel.app';

    async function loadStrict(){
      const { area, maxRent, bedsMin, zip, leaseTakeover, directOwner } = readState();
      const box = document.getElementById('strictBox');

      const allowed = ['manhattan', 'brooklyn', 'queens', 'harlem', 'upper_manhattan'];
      if (!allowed.includes(area)) {
        box.innerHTML = '<div class="text-sm text-muted">Strict non disponibile per quest’area.</div>';
        return;
      }

      const params = new URLSearchParams({ max: String(maxRent) });
      params.set('area', area);
      if (bedsMin) params.set('beds', String(bedsMin));
      if (zip) params.set('zip', zip);

      const qTerms = buildQueryTerms(leaseTakeover, directOwner);
      if (qTerms) params.set('q', qTerms);

      box.innerHTML = '<div class="text-sm text-muted">Caricamento…</div>';
      try {
        const res = await fetch(`${API_BASE}/api/listings?${params.toString()}`);
        const json = await res.json();
        box.innerHTML = '';
        if (!json.data || !json.data.length){
          box.innerHTML = '<div class="text-sm text-muted">Nessun risultato ≤ $3.000 con questi filtri.</div>';
          return;
        }
        json.data.forEach(l => {
          const a = document.createElement('a');
          a.href = l.url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'card block border border-muted rounded-2xl bg-surface p-4';
          a.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <div class="font-semibold truncate pr-2">${l.title || 'Listing'}</div>
              <span class="text-sm">$${l.price || ''}</span>
            </div>
            <div class="text-sm text-muted">ZIP ${l.zipcode || '—'}</div>
            <div class="text-xs text-muted mt-1">Fonte: Craigslist</div>
          `;
          box.appendChild(a);
        });
      } catch (e) {
        box.innerHTML = '<div class="text-sm text-red-500">Errore nel caricamento.</div>';
      }
    }

    // ===== Azioni =====
    document.getElementById('build').addEventListener('click', buildProviderCards);
    document.getElementById('strict').addEventListener('click', loadStrict);
    document.getElementById('reset').addEventListener('click', ()=>{
      document.getElementById('area').value = 'manhattan';
      document.getElementById('maxRent').value = 3000;
      document.getElementById('bedsMin').value = '';
      document.getElementById('zip').value = '';
      document.getElementById('noFee').checked = false;
      document.getElementById('leaseTakeover').checked = false;
      document.getElementById('directOwner').checked = false;
      updateLabels(); renderZipPills(); buildProviderCards();
    });
    document.getElementById('area').addEventListener('change', ()=>{
      document.getElementById('zip').value = '';
      updateLabels(); renderZipPills(); buildProviderCards();
    });
    document.getElementById('maxRent').addEventListener('input', updateLabels);
    document.getElementById('leaseTakeover').addEventListener('change', buildProviderCards);
    document.getElementById('directOwner').addEventListener('change', buildProviderCards);

    // ===== Init from query =====
    (function initFromQuery(){
      const u = new URL(location.href);
      const area = u.searchParams.get('area');
      const max = u.searchParams.get('max');
      const beds = u.searchParams.get('beds');
      const zip = u.searchParams.get('zip');
      const nofee = u.searchParams.get('nofee');
      const lt = u.searchParams.get('lt');
      const dO = u.searchParams.get('do');

      if (area && document.querySelector(`#area option[value="${area}"]`)) document.getElementById('area').value = area;
      if (max) document.getElementById('maxRent').value = max;
      if (beds) document.getElementById('bedsMin').value = beds;
      if (zip) document.getElementById('zip').value = zip;
      if (nofee) document.getElementById('noFee').checked = true;
      if (lt) document.getElementById('leaseTakeover').checked = true;
      if (dO) document.getElementById('directOwner').checked = true;

      updateLabels(); renderZipPills(); buildProviderCards();

      // sync pulsanti letti
      const seg = document.getElementById('bedsSeg');
      [...seg.children].forEach(b=>b.classList.toggle('beds-active', b.dataset.beds === (beds||'')));
    })();
  </script>
</body>
</html>
