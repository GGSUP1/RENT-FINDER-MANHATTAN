<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affitti a Manhattan ‚â§ $3.000</title>
  <meta name="description" content="Trova rapidamente affitti a Manhattan entro 3000$ con link diretti ai principali portali." />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Favicon emoji (opzionale) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèôÔ∏è</text></svg>">
  <style>
    .card:hover{ box-shadow: 0 8px 24px rgba(0,0,0,.12);}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <main class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl md:text-4xl font-bold">Affitti a Manhattan ‚â§ <span id="maxRentLabel">$3,000</span></h1>
      <p class="text-sm text-gray-400 mt-1">Pagina statica, nessuno scraping: genera <strong>link diretti</strong> con filtri precompilati. Alcuni portali potrebbero richiedere un clic aggiuntivo per applicare i filtri.</p>
    </header>

    <!-- Controls -->
    <section class="grid md:grid-cols-5 gap-3 items-end mb-6">
      <div class="md:col-span-1">
        <label class="block text-sm font-medium mb-1" for="maxRent">Budget massimo ($)</label>
        <input id="maxRent" type="number" inputmode="numeric" value="3000" min="1000" step="50"
               class="w-full border border-white/10 rounded-2xl p-3 bg-gray-800 text-gray-100" />
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium mb-1" for="bedsMin">Letti min</label>
        <select id="bedsMin" class="w-full border border-white/10 rounded-2xl p-3 bg-gray-800 text-gray-100">
          <option value="">Qualsiasi</option>
          <option value="0">Studio</option>
          <option value="1">1+</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
        </select>
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium mb-1" for="zip">ZIP (opzionale)</label>
        <input id="zip" placeholder="es. 10009" class="w-full border border-white/10 rounded-2xl p-3 bg-gray-800 text-gray-100" />
      </div>
      <div class="md:col-span-1 flex items-center gap-2">
        <input id="noFee" type="checkbox" class="w-5 h-5" />
        <label for="noFee" class="text-sm font-medium">No-fee (se disponibile)</label>
      </div>
      <div class="md:col-span-1 flex gap-2">
        <button id="build" class="flex-1 rounded-2xl px-4 py-3 bg-white text-black">Genera link</button>
        <button id="strict" class="flex-1 rounded-2xl px-4 py-3 bg-green-600 text-white" title="Mostra solo risultati ‚â§ $3.000 filtrati lato server">Strict ‚â§$3k</button>
        <button id="save" class="rounded-2xl px-4 py-3 border border-white/20 text-gray-200">Salva</button>
      </div>
    </section>

    <!-- Quick ZIP pills -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">ZIP Manhattan rapidi</h2>
      <div id="zipPills" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Avviso -->
    <section class="mb-4">
      <div class="p-3 border border-yellow-400 bg-yellow-900/30 rounded-xl text-sm text-yellow-200">
        ‚ö†Ô∏è StreetEasy e Zillow possono mostrare annunci sponsorizzati o con ‚Äúnet effective rent‚Äù sopra i $3.000 anche con filtro attivo. Usa <strong>Strict ‚â§$3k</strong> per risultati garantiti.
      </div>
    </section>

    <!-- Results (link-out) -->
    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="providers"></section>

    <!-- Strict results -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Risultati filtrati (serverless, ‚â§ $3.000)</h2>
      <div id="strictBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p class="text-xs text-gray-400 mt-2">Solo annunci ‚â§ $3.000 a Manhattan (es. Craigslist RSS), filtrati lato server.</p>
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-semibold mb-2">Ricerche salvate (locale)</h2>
      <div id="saved" class="grid md:grid-cols-3 gap-3"></div>
    </section>

    <footer class="mt-12 text-xs text-gray-500">
      <p>Nota: questa pagina non fa scraping e non usa API dei portali. Apre solo ricerche pubbliche con parametri nell‚ÄôURL. I parametri dei portali possono cambiare nel tempo.</p>
    </footer>
  </main>

  <script>
    // ---------- Utils & stato ----------
    const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    function readState(){
      const maxRent = Math.max(0, parseInt(document.getElementById('maxRent').value || '3000', 10));
      const bedsMin = document.getElementById('bedsMin').value;
      const zip = (document.getElementById('zip').value || '').trim();
      const noFee = document.getElementById('noFee').checked;
      return { maxRent, bedsMin, zip, noFee };
    }
    function updateLabel(){
      const { maxRent } = readState();
      document.getElementById('maxRentLabel').textContent = fmt.format(maxRent);
    }
    document.getElementById('maxRent').addEventListener('input', updateLabel);
    updateLabel();

    // ---------- Link generator ----------
    function getProviderLinks({ maxRent, bedsMin, zip, noFee }){
      const enc = encodeURIComponent;
      const bedsParam = bedsMin ? bedsMin : '';

      // Provider pi√π affidabili in alto
      let rh = `https://www.renthop.com/apartments-for-rent/nyc/manhattan?max_price=${maxRent}`;
      if (bedsParam) rh += `&min_beds=${bedsParam}`;
      if (noFee) rh += `&has_fee=false`;
      if (zip) rh += `&q=${zip}`;

      let cl = `https://newyork.craigslist.org/search/mnh/apa?max_price=${maxRent}`;
      if (bedsParam) cl += `&min_bedrooms=${bedsParam}`;
      if (zip) cl += `&query=${enc(zip)}`;

      let rl = `https://www.realtor.com/apartments/Manhattan_NY/price-na-${maxRent}`;
      if (bedsParam) rl += `/beds-${bedsParam}`;
      if (zip) rl = `https://www.realtor.com/apartments/${zip}/price-na-${maxRent}`;

      let hp = `https://hotpads.com/manhattan-new-york-ny/apartments-for-rent?price=-${maxRent}`;
      if (bedsParam) hp += `&beds=${bedsParam}`;
      if (zip) hp = `https://hotpads.com/${zip}/apartments-for-rent?price=-${maxRent}`;

      // Portali "sensibili" in fondo + badge
      let se = `https://streeteasy.com/for-rent/manhattan?max_price=${maxRent}`;
      if (bedsParam) se += `&beds=${bedsParam}`;
      if (noFee) se += `&no_fee=true`;
      if (zip) se += `&search=zip:${zip}`;

      let zl = `https://www.zillow.com/manhattan-new-york-ny/rentals/?price=0-${maxRent}`;
      if (bedsParam) zl += `&beds=${bedsParam}-_`;
      if (zip) zl = `https://www.zillow.com/homes/for_rent/${zip}_rb/?price=0-${maxRent}`;

      return [
        { name: 'RentHop ‚úÖ', url: rh },
        { name: 'Craigslist (Manhattan) ‚úÖ', url: cl },
        { name: 'Realtor', url: rl },
        { name: 'HotPads', url: hp },
        { name: 'StreetEasy ‚ö†Ô∏è', url: se },
        { name: 'Zillow ‚ö†Ô∏è', url: zl },
      ];
    }

    // ---------- Render provider cards ----------
    function buildProviderCards(){
      const { maxRent, bedsMin, zip, noFee } = readState();
      const p = document.getElementById('providers');
      p.innerHTML = '';

      const providers = getProviderLinks({ maxRent, bedsMin, zip, noFee });
      providers.forEach(pr => {
        const a = document.createElement('a');
        a.href = pr.url; a.target = '_blank'; a.rel = 'noopener';
        a.className = 'card block border border-white/10 rounded-2xl bg-gray-800 p-4';
        a.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${pr.name}</h3>
            <span class="text-sm text-gray-400">apri ricerca</span>
          </div>
          <p class="text-sm text-gray-300">
            Filtri: Manhattan ¬∑ max ${fmt.format(maxRent)}
            ${zip?` ¬∑ ZIP ${zip}`:''}${bedsMin?` ¬∑ ${bedsMin}+ letti`:''}${noFee?` ¬∑ no-fee`:''}
          </p>
        `;
        p.appendChild(a);
      });

      // Aggiorna URL per condivisione
      const params = new URLSearchParams();
      params.set('max', String(maxRent));
      if (bedsMin) params.set('beds', bedsMin);
      if (zip) params.set('zip', zip);
      if (noFee) params.set('nofee', '1');
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
    }

    // ---------- Salvataggi ----------
    function saveCurrent(){
      const s = readState();
      const saved = JSON.parse(localStorage.getItem('savedSearches')||'[]');
      saved.unshift({ ...s, at: Date.now() });
      localStorage.setItem('savedSearches', JSON.stringify(saved.slice(0, 12)));
      renderSaved();
    }
    function renderSaved(){
      const box = document.getElementById('saved');
      box.innerHTML='';
      const saved = JSON.parse(localStorage.getItem('savedSearches')||'[]');
      if (!saved.length){ box.innerHTML = '<p class="text-sm text-gray-500">Nessuna ricerca salvata.</p>'; return; }
      saved.forEach((s,idx)=>{
        const d = new Date(s.at);
        const card = document.createElement('div');
        card.className = 'border border-white/10 rounded-2xl bg-gray-800 p-3';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">${fmt.format(s.maxRent)}${s.zip?` ¬∑ ${s.zip}`:''}${s.bedsMin?` ¬∑ ${s.bedsMin}+bd`:''}${s.noFee?` ¬∑ no-fee`:''}</div>
              <div class="text-xs text-gray-500">${d.toLocaleString()}</div>
            </div>
            <div class="flex gap-2">
              <button class="text-xs px-2 py-1 border border-white/20 rounded" data-act="load">Apri</button>
              <button class="text-xs px-2 py-1 border border-white/20 rounded" data-act="del">Elimina</button>
            </div>
          </div>`;
        card.addEventListener('click', (ev)=>{
          const t = ev.target; if (!(t instanceof HTMLElement)) return;
          if (t.dataset.act==='del'){
            const arr = JSON.parse(localStorage.getItem('savedSearches')||'[]');
            arr.splice(idx,1); localStorage.setItem('savedSearches', JSON.stringify(arr));
            renderSaved();
          }
          if (t.dataset.act==='load'){
            document.getElementById('maxRent').value = s.maxRent;
            document.getElementById('bedsMin').value = s.bedsMin||'';
            document.getElementById('zip').value = s.zip||'';
            document.getElementById('noFee').checked = !!s.noFee;
            updateLabel();
            buildProviderCards();
          }
        });
        box.appendChild(card);
      });
    }

    // ---------- Strict mode (serverless) ----------
    // Se la pagina √® su GitHub Pages e l‚ÄôAPI √® su Vercel, metti qui il dominio Vercel:
    // const API_BASE = 'https://rent-finder-manhattan.vercel.app';
    // Se pubblichi anche la pagina su Vercel (stessa origine), lascia vuoto:
    const API_BASE = '';

    async function loadStrict(){
      const { maxRent, bedsMin, zip } = readState();
      const params = new URLSearchParams({ max: String(maxRent) });
      if (bedsMin) params.set('beds', String(bedsMin));
      if (zip) params.set('zip', zip);

      const box = document.getElementById('strictBox');
      box.innerHTML = '<div class="text-sm text-gray-300">Caricamento‚Ä¶</div>';
      try {
        const res = await fetch(`${API_BASE}/api/listings?${params.toString()}`);
        const json = await res.json();
        box.innerHTML = '';
        if (!json.data || !json.data.length){
          box.innerHTML = '<div class="text-sm text-gray-400">Nessun risultato ‚â§ $3.000 trovato con questi filtri.</div>';
          return;
        }
        json.data.forEach(l => {
          const a = document.createElement('a');
          a.href = l.url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'block border border-white/10 rounded-2xl bg-gray-800 p-4';
          a.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <div class="font-semibold truncate pr-2">${l.title || 'Listing'}</div>
              <span class="text-sm">$${l.price || ''}</span>
            </div>
            <div class="text-sm text-gray-400">ZIP ${l.zipcode || '‚Äî'}</div>
            <div class="text-xs text-gray-500 mt-1">Fonte: Craigslist</div>
          `;
          box.appendChild(a);
        });
      } catch (e) {
        box.innerHTML = '<div class="text-sm text-red-400">Errore nel caricamento.</div>';
      }
    }

    // ---------- ZIP pills (dopo che il DOM √® pronto) ----------
    window.addEventListener('DOMContentLoaded', () => {
      const MANHATTAN_ZIPS = [
        '10001','10002','10003','10004','10005','10006','10007','10009','10010','10011','10012','10013','10014',
        '10016','10017','10018','10019','10020','10021','10022','10023','10024','10025','10026','10027','10028',
        '10029','10030','10031','10032','10033','10034','10035','10036','10037','10038','10039','10040','10044',
        '10045','10048','10055','10065','10069','10075','10080','10103','10110','10111','10112','10115','10128',
        '10271','10278','10279','10280','10282'
      ];
      const zipPills = document.getElementById('zipPills');
      if (!zipPills) return;
      zipPills.innerHTML = '';
      MANHATTAN_ZIPS.forEach(z => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'px-3 py-1 rounded-full bg-white text-black border border-white/20 text-sm hover:shadow';
        b.textContent = z;
        b.addEventListener('click', () => { const i = document.getElementById('zip'); if (i) i.value = z; });
        zipPills.appendChild(b);
      });
    });

    // ---------- Init ----------
    function initFromQuery(){
      const u = new URL(location.href);
      const max = u.searchParams.get('max');
      const beds = u.searchParams.get('beds');
      const zip = u.searchParams.get('zip');
      const nofee = u.searchParams.get('nofee');
      if (max) document.getElementById('maxRent').value = max;
      if (beds) document.getElementById('bedsMin').value = beds;
      if (zip) document.getElementById('zip').value = zip;
      if (nofee) document.getElementById('noFee').checked = true;
      updateLabel();
      buildProviderCards();
      renderSaved();
    }
    initFromQuery();

    // ---------- Event listeners ----------
    document.getElementById('build').addEventListener('click', buildProviderCards);
    document.getElementById('save').addEventListener('click', saveCurrent);
    document.getElementById('strict').addEventListener('click', loadStrict);
  </script>
</body>
</html>
