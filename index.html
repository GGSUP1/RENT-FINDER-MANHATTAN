<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyCap NYC — Affitti a Manhattan ≤ $3.000</title>
  <meta name="description" content="KeyCap NYC: affitti a Manhattan entro $3.000 con link diretti ai principali portali (StreetEasy, Zillow, RentHop, Craigslist, Realtor). Filtri rapidi, quartieri, ZIP, salvataggi e Strict ≤$3k." />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    html,body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .card{ transition: transform .15s ease, box-shadow .15s ease; }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.14); }
    .btn{ border-radius: 1rem; padding:.55rem .9rem; }
    .btn-outline{ border: 1px solid var(--border); color: var(--fg); background: var(--surface); }

    :root{
      --bg: #f6f7f9; --fg: #0b0b0c;
      --surface: #ffffff; --muted: #495160;
      --border: rgba(0,0,0,.08); --accent: #16a34a;
      --warn-bg: rgba(250,204,21,.12); --warn-br: rgba(250,204,21,.35); --warn-fg: #a16207;
    }
    body{ background: var(--bg); color: var(--fg); }
    .bg-surface{ background: var(--surface); }
    .text-muted{ color: var(--muted); }
    .border-muted{ border-color: var(--border); }
    .accent-green{ accent-color: var(--accent); }
    .warn-box{ border: 1px solid var(--warn-br); background: var(--warn-bg); color: var(--warn-fg); }

    /* Dark */
    body.dark{
      --bg: #0b0c10; --fg: #f7f8fa;
      --surface: #0f1218; --muted: #9aa3ae; --border: rgba(255,255,255,.10);
      --warn-bg: rgba(234,179,8,.12); --warn-br: rgba(234,179,8,.35); --warn-fg: #eab308;
    }

    /* Segmented beds - COMPATTO SOLO QUI */
    .seg-beds{ display:flex; flex-wrap:wrap; gap:.4rem; }
    .seg-beds .seg-btn{
      min-width:74px; height:34px; font-size:.85rem; font-weight:700;
      border:1px solid var(--border); background:var(--surface); color:var(--fg);
      border-radius:12px; display:inline-flex; align-items:center; justify-content:center;
    }
    .seg-beds .seg-btn.seg-active{ background:var(--accent)!important; color:#fff!important; border-color:var(--accent)!important; }

    .zip-btn-active{ background: var(--accent)!important; color:#fff!important; border-color: var(--accent)!important; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
  </style>
</head>
<body>

  <main class="max-w-6xl mx-auto p-6">
    <!-- Header brand -->
    <header class="flex items-center gap-3 py-4 border-b border-muted mb-6">
      <!-- Logo SVG KeyCap -->
      <svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"
           class="rounded-xl shadow-sm flex-shrink-0">
        <rect width="44" height="44" rx="10" fill="#16a34a"/>
        <text x="50%" y="50%" text-anchor="middle" dy=".35em"
              font-size="22" font-family="Inter, sans-serif" font-weight="700" fill="white">K</text>
      </svg>

      <div class="min-w-0">
        <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-none">
          KeyCap <span class="text-[#16a34a]">NYC</span>
        </h1>
        <p class="text-sm text-muted mt-1">
          Affitti smart a Manhattan ≤ <span id="maxRentLabel">$3,000</span>
        </p>
      </div>

      <div class="ml-auto flex gap-2">
        <button id="theme" class="btn btn-outline">Tema</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="grid md:grid-cols-4 gap-3 items-end mb-6">
      <div>
        <label class="block text-sm font-medium mb-1" for="maxRent">Budget massimo ($)</label>
        <input id="maxRent" type="number" value="3000" min="1000" step="50"
               class="w-full border border-muted rounded-2xl p-3 bg-surface" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Letti min</label>
        <div id="bedsSeg" class="seg-beds">
          <button type="button" data-beds=""  class="seg-btn seg-active" aria-pressed="true">Qualsiasi</button>
          <button type="button" data-beds="0" class="seg-btn" aria-pressed="false">Studio</button>
          <button type="button" data-beds="1" class="seg-btn" aria-pressed="false">1+</button>
          <button type="button" data-beds="2" class="seg-btn" aria-pressed="false">2+</button>
          <button type="button" data-beds="3" class="seg-btn" aria-pressed="false">3+</button>
        </div>
        <input id="bedsMin" type="hidden" value="">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="zip">ZIP (opzionale)</label>
        <input id="zip" placeholder="es. 10009" class="w-full border border-muted rounded-2xl p-3 bg-surface" />
      </div>

      <div class="flex flex-wrap gap-2 justify-end items-center">
        <button id="copy"  class="btn btn-outline">Copia link</button>
        <button id="build" class="btn btn-outline">Genera link</button>
        <button id="strict" class="btn" style="background:#16a34a;color:#fff">Strict ≤$3k</button>
        <button id="save" class="btn btn-outline">Salva</button>
        <button id="reset" class="btn btn-outline">Reset</button>
        <label class="flex items-center gap-2 text-sm font-medium ml-1">
          <input id="noFee" type="checkbox" class="w-5 h-5 accent-green" />
          No-fee
        </label>
      </div>
    </section>

    <!-- ZIP grid -->
    <section class="mt-6 mb-2">
      <h2 class="text-lg font-semibold mb-3">ZIP Manhattan rapidi</h2>
      <!-- allineati perfettamente -->
      <div id="zipPills" class="grid grid-cols-10 gap-2 mt-1 text-sm"></div>
    </section>

    <!-- Quartieri -->
    <section class="mt-4">
      <h3 class="font-semibold mb-2">Quartieri rapidi</h3>
      <div id="hoodPills" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Avviso -->
    <section class="mt-6 mb-6">
      <div class="warn-box rounded-xl px-4 py-3 text-sm">
        ⚠️ StreetEasy e Zillow possono mostrare annunci sponsorizzati o con “net effective rent” sopra i $3.000 anche con filtro attivo.
        Usa <strong>Strict ≤$3k</strong> per risultati garantiti.
      </div>
    </section>

    <!-- Provider links -->
    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="providers"></section>

    <!-- Strict results -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Risultati filtrati (serverless, ≤ $3.000)</h2>
      <div id="strictBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p class="text-xs text-muted mt-2">Solo annunci ≤ $3.000 a Manhattan (es. Craigslist RSS), filtrati lato server.</p>
    </section>

    <!-- Saved -->
    <section class="mt-10">
      <h2 class="text-lg font-semibold mb-2">Ricerche salvate (locale)</h2>
      <div id="saved" class="grid md:grid-cols-3 gap-3"></div>
    </section>

    <footer class="mt-12 text-xs text-muted">
      <p>Questa pagina non fa scraping e non usa API dei portali. Apre ricerche pubbliche con parametri nell'URL. I parametri dei portali possono cambiare nel tempo.</p>
    </footer>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 pointer-events-none
    px-4 py-2 rounded-xl bg-black/80 text-white text-sm shadow-lg opacity-0 transition-opacity">
    Copiato!
  </div>

  <script>
    // ===== Tema =====
    (function initTheme(){
      const saved = localStorage.getItem('theme');
      if (!saved) localStorage.setItem('theme','light');
      if (saved==='dark') document.body.classList.add('dark');
    })();
    document.getElementById('theme').addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark')?'dark':'light');
    });

    // ===== Costanti =====
    const MANHATTAN_ZIPS = [
      '10001','10002','10003','10004','10005','10006','10007','10009','10010','10011','10012','10013','10014',
      '10016','10017','10018','10019','10021','10022','10023','10024','10025','10026','10027','10028',
      '10029','10030','10031','10032','10033','10034','10035','10036','10037','10038','10039','10040',
      '10044','10065','10069','10075','10280','10282'
    ];
    const HOODS = {
      "Chelsea": "10011", "West Village": "10014", "East Village": "10009", "SoHo": "10012",
      "Lower East Side": "10002", "Upper West Side": "10024", "Upper East Side": "10021",
      "Harlem": "10027", "Financial District": "10004", "Midtown": "10019"
    };
    const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // ===== Stato =====
    function readState(){
      const maxRent = Math.max(0, parseInt(document.getElementById('maxRent').value || '3000', 10));
      const bedsMin = document.getElementById('bedsMin').value;
      const zip = (document.getElementById('zip').value || '').trim();
      const noFee = document.getElementById('noFee').checked;
      return { maxRent, bedsMin, zip, noFee };
    }
    function updateLabel(){ document.getElementById('maxRentLabel').textContent = fmt.format(readState().maxRent); }
    document.getElementById('maxRent').addEventListener('input', updateLabel); updateLabel();

    // ===== Beds segmented =====
    (function initBedsSeg(){
      const seg = document.getElementById('bedsSeg');
      const hidden = document.getElementById('bedsMin');
      const setActive = (val)=>{
        hidden.value = val;
        [...seg.querySelectorAll('.seg-btn')].forEach(b=>{
          const on = (b.dataset.beds === val);
          b.classList.toggle('seg-active', on);
          b.setAttribute('aria-pressed', on ? 'true' : 'false');
        });
      };
      seg.addEventListener('click', (e)=>{
        const b = e.target.closest('.seg-btn[data-beds]'); if (!b) return;
        setActive(b.dataset.beds); buildProviderCards();
      });
      setActive(hidden.value || '');
    })();

    // ===== ZIP pills (grid allineata) =====
    function renderZipPills(){
      const box = document.getElementById('zipPills'); box.innerHTML='';
      const current = (document.getElementById('zip').value||'').trim();
      MANHATTAN_ZIPS.forEach(z=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='px-3 py-1 rounded-full border border-muted bg-surface text-sm hover:bg-[#16a34a] hover:text-white hover:border-[#16a34a] transition';
        b.textContent=z;
        if(current===z) b.classList.add('zip-btn-active');
        b.onclick=()=>{ document.getElementById('zip').value=(current===z)?'':z; renderZipPills(); buildProviderCards(); };
        box.appendChild(b);
      });
    }
    renderZipPills();

    // ===== Quartieri rapidi =====
    (function renderHoods(){
      const box=document.getElementById('hoodPills');
      Object.entries(HOODS).forEach(([name, zip])=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='px-3 py-1 rounded-full border border-muted bg-surface text-sm hover:bg-[#16a34a] hover:text-white hover:border-[#16a34a] transition';
        b.textContent=name;
        b.onclick=()=>{ document.getElementById('zip').value=zip; renderZipPills(); buildProviderCards(); };
        box.appendChild(b);
      });
    })();

    // ===== Provider Links =====
    function getProviderLinks({ maxRent, bedsMin, zip, noFee }){
      const enc = encodeURIComponent;
      const bedsParam = bedsMin ? bedsMin : '';
      let se = `https://streeteasy.com/for-rent/manhattan?max_price=${maxRent}`;
      if (bedsParam) se += `&beds=${bedsParam}`;
      if (noFee) se += `&no_fee=true`;
      if (zip) se += `&search=zip:${zip}`;

      let zl = `https://www.zillow.com/manhattan-new-york-ny/rentals/?price=0-${maxRent}`;
      if (bedsParam) zl += `&beds=${bedsParam}-_`;
      if (zip) zl = `https://www.zillow.com/homes/for_rent/${zip}_rb/?price=0-${maxRent}`;

      let rh = `https://www.renthop.com/apartments-for-rent/nyc/manhattan?max_price=${maxRent}`;
      if (bedsParam) rh += `&min_beds=${bedsParam}`;
      if (noFee) rh += `&has_fee=false`;
      if (zip) rh += `&q=${zip}`;

      let cl = `https://newyork.craigslist.org/search/mnh/apa?max_price=${maxRent}`;
      if (bedsParam) cl += `&min_bedrooms=${bedsParam}`;
      if (zip) cl += `&query=${enc(zip)}`;

      let rl = `https://www.realtor.com/apartments/Manhattan_NY/price-na-${maxRent}`;
      if (bedsParam) rl += `/beds-${bedsParam}`;
      if (zip) rl = `https://www.realtor.com/apartments/${zip}/price-na-${maxRent}`;

      let hp = `https://hotpads.com/manhattan-new-york-ny/apartments-for-rent?price=-${maxRent}`;
      if (bedsParam) hp += `&beds=${bedsParam}`;
      if (zip) hp = `https://hotpads.com/${zip}/apartments-for-rent?price=-${maxRent}`;

      return [
        { name: 'RentHop ✅', url: rh },
        { name: 'Craigslist (Manhattan) ✅', url: cl },
        { name: 'Realtor', url: rl },
        { name: 'HotPads', url: hp },
        { name: 'StreetEasy ⚠️', url: se },
        { name: 'Zillow ⚠️', url: zl },
      ];
    }

    function buildProviderCards(){
      const { maxRent, bedsMin, zip, noFee } = readState();
      const p = document.getElementById('providers'); p.innerHTML='';
      const providers = getProviderLinks({ maxRent, bedsMin, zip, noFee });
      providers.forEach(pr=>{
        const a=document.createElement('a');
        a.href=pr.url; a.target='_blank'; a.rel='noopener';
        a.className='card block border border-muted rounded-2xl bg-surface p-4';
        a.innerHTML=`
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${pr.name}</h3>
            <span class="inline-flex items-center gap-1 text-sm text-muted">
              apri ricerca
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-70">
                <path d="M7 17L17 7M17 7H9M17 7v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </div>
          <p class="text-sm text-muted">Filtri: Manhattan · max ${fmt.format(maxRent)}${zip?` · ZIP ${zip}`:''}${bedsMin?` · ${bedsMin}+ letti`:''}${noFee?` · no-fee`:''}</p>`;
        p.appendChild(a);
      });

      // share URL
      const params = new URLSearchParams();
      params.set('max', String(maxRent));
      if (bedsMin) params.set('beds', bedsMin);
      if (zip) params.set('zip', zip);
      if (noFee) params.set('nofee', '1');
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
    }

    // ===== Strict (serverless) =====
    const API_BASE = 'https://TUO-PROGETTO-VERCEL.vercel.app'; // 👈 Sostituisci con il tuo dominio Vercel

    async function loadStrict(){
      const { maxRent, bedsMin, zip } = readState();
      const params = new URLSearchParams({ max: String(maxRent) });
      if (bedsMin) params.set('beds', String(bedsMin));
      if (zip) params.set('zip', zip);

      const box = document.getElementById('strictBox');
      box.innerHTML = '<div class="text-sm text-muted">Caricamento…</div>';
      try {
        const res = await fetch(`${API_BASE}/api/listings?${params.toString()}`);
        const json = await res.json();
        box.innerHTML = '';
        if (!json.data || !json.data.length){
          box.innerHTML = '<div class="text-sm text-muted">Nessun risultato ≤ $3.000 trovato con questi filtri.</div>';
          return;
        }
        json.data.forEach(l=>{
          const a=document.createElement('a');
          a.href=l.url; a.target='_blank'; a.rel='noopener';
          a.className='card block border border-muted rounded-2xl bg-surface p-4';
          a.innerHTML=`
            <div class="flex items-center justify-between mb-1">
              <div class="font-semibold truncate pr-2">${l.title || 'Listing'}</div>
              <span class="text-sm">$${l.price || ''}</span>
            </div>
            <div class="text-sm text-muted">ZIP ${l.zipcode || '—'}</div>
            <div class="text-xs text-muted mt-1">Fonte: Craigslist</div>`;
          box.appendChild(a);
        });
      } catch (e) {
        box.innerHTML = '<div class="text-sm text-red-600">Errore nel caricamento.</div>';
      }
    }

    // ===== Copia, Salva, Reset, Toast =====
    function showToast(msg='Fatto!'){
      const t=document.getElementById('toast'); t.textContent=msg;
      t.classList.remove('opacity-0'); setTimeout(()=>t.classList.add('opacity-0'),1400);
    }
    document.getElementById('copy').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); showToast('Link copiato'); }
      catch{ showToast('Impossibile copiare'); }
    });
    function saveCurrent(){
      const s=readState(); const saved=JSON.parse(localStorage.getItem('savedSearches')||'[]');
      saved.unshift({ ...s, at: Date.now() }); localStorage.setItem('savedSearches', JSON.stringify(saved.slice(0,12)));
      renderSaved(); showToast('Ricerca salvata');
    }
    function renderSaved(){
      const box=document.getElementById('saved'); box.innerHTML='';
      const saved=JSON.parse(localStorage.getItem('savedSearches')||'[]');
      if(!saved.length){ box.innerHTML='<p class="text-sm text-muted">Nessuna ricerca salvata.</p>'; return; }
      saved.forEach((s,idx)=>{
        const d=new Date(s.at);
        const card=document.createElement('div');
        card.className='border border-muted rounded-2xl bg-surface p-3';
        card.innerHTML=`
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">${fmt.format(s.maxRent)}${s.zip?` · ${s.zip}`:''}${s.bedsMin?` · ${s.bedsMin}+bd`:''}${s.noFee?` · no-fee`:''}</div>
              <div class="text-xs text-muted">${d.toLocaleString()}</div>
            </div>
            <div class="flex gap-2">
              <button class="text-xs px-2 py-1 border border-muted rounded" data-act="load">Apri</button>
              <button class="text-xs px-2 py-1 border border-muted rounded" data-act="del">Elimina</button>
            </div>
          </div>`;
        card.addEventListener('click', (ev)=>{
          const t=ev.target; if(!(t instanceof HTMLElement)) return;
          if(t.dataset.act==='del'){
            const arr=JSON.parse(localStorage.getItem('savedSearches')||'[]'); arr.splice(idx,1);
            localStorage.setItem('savedSearches', JSON.stringify(arr)); renderSaved();
          }
          if(t.dataset.act==='load'){
            document.getElementById('maxRent').value = s.maxRent;
            document.getElementById('bedsMin').value = s.bedsMin||'';
            document.getElementById('zip').value = s.zip||'';
            document.getElementById('noFee').checked = !!s.noFee;
            updateLabel(); renderZipPills(); buildProviderCards(); showToast('Ricerca caricata');
            // sync segmented
            const seg=document.getElementById('bedsSeg');
            [...seg.children].forEach(b=>b.classList.toggle('seg-active', b.dataset.beds === (s.bedsMin||'')));
          }
        });
        box.appendChild(card);
      });
    }
    document.getElementById('save').addEventListener('click', saveCurrent);
    document.getElementById('reset').addEventListener('click', ()=>{
      document.getElementById('maxRent').value=3000;
      document.getElementById('bedsMin').value='';
      document.getElementById('zip').value='';
      document.getElementById('noFee').checked=false;
      updateLabel(); renderZipPills(); buildProviderCards(); showToast('Filtri ripristinati');
      const seg=document.getElementById('bedsSeg');
      [...seg.children].forEach(b=>b.classList.toggle('seg-active', b.dataset.beds===''));
    });
