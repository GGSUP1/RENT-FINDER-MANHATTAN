<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyCap NYC — Lease Hunter ≤ $3.000</title>
  <meta name="description" content="KeyCap NYC: radar per affitti ≤ $3.000 a Manhattan, Brooklyn e Queens. Quartieri, Strict, Lease Takeover, Direct to Owner, Corporate/Assignable e filtri smart." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    html,body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    :root{
      --bg:#0b0c10; --fg:#f7f8fa; --surface:#11151c; --muted:#9aa3ae;
      --border:rgba(255,255,255,.10); --accent:#16a34a; --accent-700:#15803d;
      --warn-bg:rgba(234,179,8,.12); --warn-br:rgba(234,179,8,.35); --warn-fg:#eab308;
    }
    body{ background:var(--bg); color:var(--fg); }
    .bg-surface{ background:var(--surface); }
    .text-muted{ color:var(--muted); }
    .border-muted{ border-color:var(--border); }

    .btn{ height:40px; padding:0 .9rem; border-radius:.8rem; font-weight:700; font-size:.9rem; display:inline-flex; align-items:center; gap:.45rem; }
    .btn-ghost{ border:1px solid var(--border); background:var(--surface); color:var(--fg); }
    .btn-ghost:hover{ border-color:#ffffff33; }
    .btn-primary{ background:var(--accent); color:#fff; }
    .btn-primary:hover{ background:var(--accent-700); }
    .btn-outline{ border:1px solid var(--border); background:rgba(255,255,255,.9); color:#0b0c10; }
    .btn-outline:hover{ border-color:#cbd5e1; }

    .input, .select{
      height:40px; border-radius:.8rem; border:1px solid var(--border); background:var(--surface);
      padding:.35rem .8rem; color:var(--fg);
    }
    .input::placeholder{ color:#94a3b8; }

    .seg-btn{
      height:36px; padding:0 .7rem; border-radius:.6rem; border:1px solid var(--border);
      background:var(--surface); color:var(--fg); font-weight:700; font-size:.85rem;
    }
    .seg-btn:hover{ background:rgba(22,163,74,.10); border-color:var(--accent); }
    .seg-active{ background:var(--accent) !important; color:#fff !important; border-color:var(--accent) !important; }

    .chip{
      height:34px; padding:0 .7rem; border-radius:.7rem; border:1px solid var(--border);
      background:var(--surface); font-size:.85rem; font-weight:700; color:var(--fg);
    }
    .chip:hover{ background:rgba(22,163,74,.10); border-color:var(--accent); }
    .chip-active{ background:var(--accent) !important; border-color:var(--accent) !important; color:#fff !important; }

    .card{ border:1px solid var(--border); border-radius:1rem; background:var(--surface); padding:1rem; transition:transform .15s ease, box-shadow .15s ease; }
    .card:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.14); }

    .badge{ font-size:.65rem; padding:.15rem .4rem; border-radius:.4rem; border:1px solid var(--border); color:var(--muted); }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    input[type="checkbox"]{ accent-color:var(--accent); width:18px; height:18px; }
  </style>
</head>

<body>
<main class="max-w-6xl mx-auto p-6">

  <!-- Header -->
  <header class="flex items-center gap-3 py-4 border-b border-muted mb-6">
    <svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg" class="rounded-xl">
      <rect width="44" height="44" rx="10" fill="#16a34a"/>
      <text x="50%" y="50%" text-anchor="middle" dy=".35em" font-size="22" font-family="Inter" font-weight="700" fill="white">K</text>
    </svg>
    <div>
      <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-none">
        KeyCap <span class="text-[#16a34a]">NYC</span>
      </h1>
      <p class="text-sm text-muted mt-1">
        Lease Hunter in <span id="areaLabel">Manhattan</span> ≤ <span id="maxRentLabel">$3,000</span>
      </p>
    </div>
  </header>

  <!-- Warning -->
  <section class="mt-1 mb-5">
    <div class="rounded-xl px-4 py-3 text-sm border border-[var(--warn-br)] bg-[var(--warn-bg)] text-[var(--warn-fg)]">
      ⚠️ Alcuni portali mostrano sponsorizzati o “net effective”. <strong>Strict</strong> filtra realmente ≤ $3.000 tramite Craigslist.
    </div>
  </section>

  <!-- Filters -->
  <section class="space-y-3 mb-6">

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-3">
      <div>
        <label class="block text-xs font-semibold mb-1">Area</label>
        <select id="area" class="select w-full">
          <option value="manhattan" selected>Manhattan</option>
          <option value="harlem">Harlem</option>
          <option value="upper_manhattan">Upper Manhattan</option>
          <option value="brooklyn">Brooklyn</option>
          <option value="queens">Queens</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-semibold mb-1">Budget ($)</label>
        <input id="maxRent" type="number" value="3000" class="input w-full">
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-semibold mb-1">Letti min</label>
        <div id="bedsSeg" class="flex flex-wrap gap-2">
          <button type="button" data-beds="" class="seg-btn seg-active">Qualsiasi</button>
          <button type="button" data-beds="0" class="seg-btn">Studio</button>
          <button type="button" data-beds="1" class="seg-btn">1+</button>
          <button type="button" data-beds="2" class="seg-btn">2+</button>
          <button type="button" data-beds="3" class="seg-btn">3+</button>
          <button type="button" data-beds="4" class="seg-btn">4+</button>
        </div>
        <input id="bedsMin" type="hidden" value="">
      </div>

      <div>
        <label class="block text-xs font-semibold mb-1">ZIP (opz.)</label>
        <input id="zip" class="input w-full" placeholder="10009 / 11211">
      </div>
    </div>

    <div class="flex flex-wrap gap-2 items-center">
      <button id="build" class="btn btn-outline">Genera link</button>
      <button id="strict" class="btn btn-primary">Strict ≤$3k</button>
      <button id="reset" class="btn btn-ghost">Reset</button>

      <label class="flex items-center gap-2 text-sm font-semibold"><input id="noFee" type="checkbox"> No-fee</label>
      <label class="flex items-center gap-2 text-sm font-semibold"><input id="leaseTakeover" type="checkbox"> Lease takeover</label>
      <label class="flex items-center gap-2 text-sm font-semibold"><input id="directOwner" type="checkbox"> Direct owner</label>
      <label class="flex items-center gap-2 text-sm font-semibold"><input id="corpAssignable" type="checkbox"> Corporate/Assignable</label>
    </div>

  </section>

  <!-- Neighborhood Pills -->
  <section class="mt-2 mb-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-base font-semibold">Quartieri rapidi (<span id="nabeAreaLabel">Manhattan</span>)</h2>
      <button id="clearNabe" class="btn btn-ghost h-8">Pulisci</button>
    </div>
    <div id="nabePills" class="flex flex-wrap gap-2"></div>
  </section>

  <!-- Providers -->
  <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="providers"></section>

  <!-- Strict Results -->
  <section class="mt-8">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-base font-semibold">Strict (Craigslist) ≤ $3.000</h2>
      <span class="badge">solo ≤$3k</span>
    </div>

    <!-- NEW NOTICE FOR 4+ -->
    <p id="strictNotice" class="text-sm text-yellow-400 mt-1 hidden">
      Strict 4+ Bedrooms: filtraggio reale delle camere disponibile solo tramite Craigslist.
    </p>

    <div id="strictBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mt-3"></div>
  </section>

</main>

<script>
const API_BASE = "https://rent-finder-manhattan.vercel.app";

/* -------------------------
   Helpers & Data
------------------------- */

const NABES = {
  manhattan: [
    { name:'SoHo', zip:'10012' }, { name:'NoHo', zip:'10012' }, { name:'Tribeca', zip:'10013' },
    { name:'Financial District', zip:'10005' }, { name:'Battery Park City', zip:'10280' },
    { name:'West Village', zip:'10014' }, { name:'Chelsea', zip:'10011' }, { name:'Flatiron', zip:'10010' },
    { name:'Gramercy', zip:'10010' }, { name:'Kips Bay', zip:'10016' }, { name:'Murray Hill', zip:'10016' },
    { name:'Midtown West', zip:'10019' }, { name:'Midtown East', zip:'10022' }, { name:'Hell’s Kitchen', zip:'10036' },
    { name:'Upper West Side', zip:'10024' }, { name:'Upper East Side', zip:'10028' },
    { name:'Harlem', zip:'10027' }, { name:'Washington Heights', zip:'10033' }, { name:'Inwood', zip:'10034' },
    { name:'East Village', zip:'10009' }, { name:'Lower East Side', zip:'10002' }
  ],
  brooklyn: [
    { name:'Williamsburg', zip:'11211' }, { name:'Greenpoint', zip:'11222' }, { name:'Bushwick', zip:'11237' },
    { name:'Bed-Stuy', zip:'11216' }, { name:'Fort Greene', zip:'11205' }, { name:'Brooklyn Heights', zip:'11201' },
    { name:'DUMBO', zip:'11201' }, { name:'Cobble Hill', zip:'11231' }, { name:'Carroll Gardens', zip:'11231' }
  ],
  queens: [
    { name:'Astoria', zip:'11102' }, { name:'Long Island City', zip:'11101' }, { name:'Sunnyside', zip:'11104' }
  ]
};


/* -------------------------
   Read filters
------------------------- */

function readState() {
  return {
    area: document.getElementById("area").value,
    maxRent: Number(document.getElementById("maxRent").value),
    bedsMin: document.getElementById("bedsMin").value,
    zip: document.getElementById("zip").value.trim(),
    noFee: document.getElementById("noFee").checked,
    leaseTakeover: document.getElementById("leaseTakeover").checked,
    directOwner: document.getElementById("directOwner").checked,
    corpAssignable: document.getElementById("corpAssignable").checked
  };
}

/* -------------------------
   Strict Loader (AUTO 4+ LOGIC)
------------------------- */

async function loadStrict(){
  const { area, maxRent, bedsMin, zip } = readState();
  const box = document.getElementById("strictBox");

  const allow = ["manhattan","brooklyn","queens","harlem","upper_manhattan"];
  if (!allow.includes(area)){
    box.innerHTML = "<div class='text-sm text-muted'>Strict non disponibile per quest’area.</div>";
    return;
  }

  // Auto-switch 4+
  const isFourPlus = bedsMin && Number(bedsMin) >= 4;

  const notice = document.getElementById("strictNotice");
  if (isFourPlus) notice.classList.remove("hidden");
  else notice.classList.add("hidden");

  const params = new URLSearchParams();
  params.set("area", area);
  params.set("max", String(maxRent));
  if (zip) params.set("zip", zip);

  let endpoint = "";

  if (isFourPlus){
    params.set("beds", "4");
    endpoint = `${API_BASE}/api/strict-bedrooms?${params.toString()}`;
  } else {
    if (bedsMin) params.set("beds", bedsMin);
    endpoint = `${API_BASE}/api/listings?${params.toString()}`;
  }

  box.innerHTML = "<div class='text-sm text-muted'>Caricamento…</div>";

  const res = await fetch(endpoint);
  const json = await res.json();

  box.innerHTML = "";

  if (!json.data || !json.data.length){
    box.innerHTML = "<div class='text-sm text-muted'>Nessun risultato trovato.</div>";
    return;
  }

  json.data.forEach(l => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <a href="${l.url}" target="_blank" class="font-semibold hover:underline block truncate">${l.title}</a>
          <div class="text-sm text-muted mt-1 flex flex-wrap gap-2">
            <span class="badge">$${l.price || ""}</span>
            ${l.bedrooms ? `<span class="badge">${l.bedrooms} BR</span>` : ""}
            ${l.hood ? `<span class="badge">${l.hood}</span>` : ""}
            <span class="badge">Craigslist</span>
          </div>
        </div>
        <a href="${l.url}" target="_blank" class="btn btn-ghost h-8">Apri</a>
      </div>`;
    box.appendChild(card);
  });
}

/* -------------------------
   Events
------------------------- */

document.getElementById("strict").addEventListener("click", loadStrict);

document.getElementById("reset").addEventListener("click", ()=>{
  document.getElementById("area").value="manhattan";
  document.getElementById("maxRent").value=3000;
  document.getElementById("bedsMin").value="";
  document.getElementById("zip").value="";
  document.getElementById("noFee").checked=false;
  document.getElementById("leaseTakeover").checked=false;
  document.getElementById("directOwner").checked=false;
  document.getElementById("corpAssignable").checked=false;
});

</script>

</body>
</html>
