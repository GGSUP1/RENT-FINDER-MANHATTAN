<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyCap NYC — Lease Hunter ≤ $3.000</title>
  <meta name="description" content="KeyCap NYC: radar per affitti ≤ $3.000 a Manhattan, Brooklyn e Queens. Quartieri, Strict, Lease Takeover, Direct to Owner, Corporate/Assignable e salvataggio opportunità." />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    html,body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    :root{
      --bg: #0b0c10; --fg: #f7f8fa; --surface: #11151c; --muted: #9aa3ae;
      --border: rgba(255,255,255,.10); --accent: #16a34a; --accent-700: #15803d;
      --warn-bg: rgba(234,179,8,.12); --warn-br: rgba(234,179,8,.35); --warn-fg: #eab308;
    }
    body{ background: var(--bg); color: var(--fg); }
    .bg-surface{ background: var(--surface); }
    .text-muted{ color: var(--muted); }
    .border-muted{ border-color: var(--border); }
    .card{ transition: transform .15s ease, box-shadow .15s ease; }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.14); }
    .chip{
      padding: .45rem .7rem; border-radius: .75rem; border: 1px solid var(--border);
      background: var(--surface); font-size: .85rem; font-weight: 700; color: var(--fg);
      transition: background .15s, border-color .15s, color .15s, transform .05s;
      white-space: nowrap;
    }
    .chip:hover{ background: rgba(22,163,74,.10); border-color: var(--accent); }
    .chip-active{ background: var(--accent) !important; border-color: var(--accent) !important; color: #fff !important; }
    .beds-btn{
      padding: .35rem .6rem; font-size: .85rem; border-radius: .6rem;
      border: 1px solid var(--border); background: var(--surface); color: var(--fg);
      font-weight: 700; transition: background .15s, color .15s, border-color .15s;
    }
    .beds-btn:hover{ background: rgba(22,163,74,.10); border-color: var(--accent); }
    .beds-active{ background: var(--accent) !important; color:#fff !important; border-color: var(--accent) !important; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type="checkbox"]{ accent-color: var(--accent); }
    .badge{ font-size:.65rem; padding:.15rem .4rem; border-radius:.4rem; border:1px solid var(--border); color:var(--muted);}
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <header class="flex items-center gap-3 py-4 border-b border-muted mb-6">
      <svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg" class="rounded-xl">
        <rect width="44" height="44" rx="10" fill="#16a34a"/>
        <text x="50%" y="50%" text-anchor="middle" dy=".35em"
              font-size="22" font-family="Inter, sans-serif" font-weight="700" fill="white">K</text>
      </svg>
      <div class="min-w-0">
        <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-none">
          KeyCap <span class="text-[#16a34a]">NYC</span>
        </h1>
        <p class="text-sm text-muted mt-1">
          Lease Hunter in <span id="areaLabel">Manhattan</span> ≤ <span id="maxRentLabel">$3,000</span>
        </p>
      </div>
    </header>

    <!-- Avviso -->
    <section class="mt-1 mb-5">
      <div class="rounded-xl px-4 py-3 text-sm border border-[var(--warn-br)] bg-[var(--warn-bg)] text-[var(--warn-fg)]">
        ⚠️ Alcuni portali mostrano sponsorizzati o “net effective” sopra soglia. <strong>Strict</strong> ti mostra solo risultati ≤ $3.000 (Craigslist).
      </div>
    </section>

    <!-- Controlli -->
    <section class="grid md:grid-cols-5 gap-3 items-end mb-6">
      <div>
        <label class="block text-sm font-semibold mb-1" for="area">Area</label>
        <select id="area" class="w-full border border-muted rounded-2xl p-3 bg-surface">
          <option value="manhattan" selected>Manhattan</option>
          <option value="harlem">Harlem</option>
          <option value="upper_manhattan">Upper Manhattan</option>
          <option value="brooklyn">Brooklyn</option>
          <option value="queens">Queens</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1" for="maxRent">Budget ($)</label>
        <input id="maxRent" type="number" value="3000" min="800" step="50"
               class="w-full border border-muted rounded-2xl p-3 bg-surface" />
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Letti min</label>
        <div id="bedsSeg" class="flex flex-wrap gap-2">
          <button type="button" data-beds=""  class="beds-btn beds-active">Qualsiasi</button>
          <button type="button" data-beds="0" class="beds-btn">Studio</button>
          <button type="button" data-beds="1" class="beds-btn">1+</button>
          <button type="button" data-beds="2" class="beds-btn">2+</button>
          <button type="button" data-beds="3" class="beds-btn">3+</button>
        </div>
        <input id="bedsMin" type="hidden" value="">
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1" for="zip">ZIP (opz.)</label>
        <input id="zip" placeholder="es. 10009 o 11211" class="w-full border border-muted rounded-2xl p-3 bg-surface" />
      </div>

      <div class="flex flex-wrap gap-2 justify-end items-center">
        <button id="build" class="px-4 py-2 rounded-xl border border-muted bg-white/90 text-black text-sm">Genera link</button>
        <button id="strict" class="px-4 py-2 rounded-xl bg-[var(--accent)] hover:bg-[var(--accent-700)] text-white text-sm">Strict ≤$3k</button>
        <button id="reset" class="px-4 py-2 rounded-xl border border-muted bg-surface text-sm">Reset</button>
        <label class="flex items-center gap-2 text-sm font-semibold">
          <input id="noFee" type="checkbox" class="w-5 h-5" />
          No-fee
        </label>
        <label class="flex items-center gap-2 text-sm font-semibold" title="Subentro: assignment/takeover/break">
          <input id="leaseTakeover" type="checkbox" class="w-5 h-5" />
          Lease takeover
        </label>
        <label class="flex items-center gap-2 text-sm font-semibold" title="Annunci diretti (esclude sublet/room/short-term)">
          <input id="directOwner" type="checkbox" class="w-5 h-5" />
          Direct to owner
        </label>
        <label class="flex items-center gap-2 text-sm font-semibold" title="Lease aziendali o assegnabili">
          <input id="corpAssignable" type="checkbox" class="w-5 h-5" />
          Corporate / Assignable
        </label>
      </div>
    </section>

    <!-- Quartieri -->
    <section class="mt-2 mb-2">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Quartieri rapidi (<span id="nabeAreaLabel">Manhattan</span>)</h2>
        <button id="clearNabe" class="text-xs px-2 py-1 rounded border border-muted text-muted hover:text-white hover:border-white/30">Pulisci selezione</button>
      </div>
      <div id="nabePills" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Provider cards -->
    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="providers"></section>

    <!-- Strict -->
    <section class="mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold mb-2">Strict (Craigslist) ≤ $3.000</h2>
        <span class="badge">solo ≤$3k</span>
      </div>
      <div id="strictBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p class="text-xs text-muted mt-2" id="strictNote">
        Strict attivo per Manhattan, Brooklyn e Queens (Harlem/Upper Manhattan = Manhattan).
      </p>
    </section>

    <!-- Opportunità salvate -->
    <section class="mt-10">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Opportunità salvate</h2>
        <button id="clearSaved" class="text-xs px-2 py-1 rounded border border-muted text-muted hover:text-white hover:border-white/30">Svuota</button>
      </div>
      <div id="savedBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mt-2"></div>
      <p id="savedEmpty" class="text-sm text-muted mt-2">Nessuna opportunità salvata.</p>
    </section>

    <footer class="mt-12 text-xs text-muted">
      <p>Questa pagina apre ricerche pubbliche con parametri nell'URL. I portali possono cambiare i parametri nel tempo.</p>
    </footer>
  </main>

  <script>
    // ===== Quartieri -> ZIP =====
    const NABES = {
      manhattan: [
        { name:'SoHo', zip:'10012' }, { name:'NoHo', zip:'10012' }, { name:'Tribeca', zip:'10013' },
        { name:'Financial District', zip:'10005' }, { name:'Battery Park City', zip:'10280' },
        { name:'West Village', zip:'10014' }, { name:'Chelsea', zip:'10011' }, { name:'Flatiron', zip:'10010' },
        { name:'Gramercy', zip:'10010' }, { name:'Kips Bay', zip:'10016' }, { name:'Murray Hill', zip:'10016' },
        { name:'Midtown West', zip:'10019' }, { name:'Midtown East', zip:'10022' }, { name:'Hell’s Kitchen', zip:'10036' },
        { name:'Upper West Side', zip:'10024' }, { name:'Upper East Side', zip:'10028' },
        { name:'Harlem', zip:'10027' }, { name:'Washington Heights', zip:'10033' }, { name:'Inwood', zip:'10034' },
        { name:'East Village', zip:'10009' }, { name:'Lower East Side', zip:'10002' }
      ],
      harlem: [
        { name:'Central Harlem', zip:'10027' }, { name:'East Harlem', zip:'10029' }, { name:'Hamilton Heights', zip:'10031' }
      ],
      upper_manhattan: [
        { name:'Washington Heights', zip:'10033' }, { name:'Inwood', zip:'10034' }, { name:'Marble Hill', zip:'10463' }
      ],
      brooklyn: [
        { name:'Williamsburg', zip:'11211' }, { name:'Greenpoint', zip:'11222' }, { name:'Bushwick', zip:'11237' },
        { name:'Bed-Stuy', zip:'11216' }, { name:'Fort Greene', zip:'11205' }, { name:'Brooklyn Heights', zip:'11201' },
        { name:'DUMBO', zip:'11201' }, { name:'Cobble Hill', zip:'11231' }, { name:'Carroll Gardens', zip:'11231' },
        { name:'Park Slope', zip:'11215' }, { name:'Crown Heights', zip:'11213' }, { name:'Prospect Heights', zip:'11238' },
        { name:'Bay Ridge', zip:'11209' }
      ],
      queens: [
        { name:'Astoria', zip:'11102' }, { name:'Long Island City', zip:'11101' }, { name:'Sunnyside', zip:'11104' },
        { name:'Jackson Heights', zip:'11372' }, { name:'Woodside', zip:'11377' }, { name:'Forest Hills', zip:'11375' },
        { name:'Flushing', zip:'11354' }, { name:'Ridgewood', zip:'11385' }
      ]
    };

    // ===== Helpers: query terms =====
    function buildQueryTerms(leaseTakeover, directOwner, corpAssignable){
      const t = [];
      if (leaseTakeover) t.push('(lease assignment OR lease takeover OR lease break OR assume lease OR landlord approval)');
      if (directOwner)   t.push('(direct to owner OR owner managed OR management OR leasing office OR no broker OR apply through management OR sponsor unit)', '(-sublet -room -roommate -short-term -temporary -share)');
      if (corpAssignable) t.push('(corporate lease OR assignable lease OR sublet allowed OR subletting allowed OR assignment permitted OR corporate housing)');
      return t.join(' ');
    }
    function buildSimpleTerms(leaseTakeover, directOwner, corpAssignable){
      // versione “senza parentesi” per Craigslist (evita 404)
      const t = [];
      if (leaseTakeover)  t.push('lease takeover','assignment','assume lease','lease break','landlord approval');
      if (directOwner)    t.push('direct to owner','owner managed','management','leasing office','no broker','sponsor unit');
      if (corpAssignable) t.push('corporate lease','assignable lease','sublet allowed','assignment permitted','corporate housing');
      return t.join(' ');
    }

    // ===== Slugs area =====
    function getAreaSlugs(area){
      const seArea = (area==='brooklyn'||area==='queens') ? area : 'manhattan';
      const zlAreaMap = { manhattan: 'manhattan-new-york-ny', brooklyn: 'brooklyn-new-york-ny', queens: 'queens-new-york-ny' };
      const zlArea = zlAreaMap[area] || zlAreaMap['manhattan'];
      const clAreaMap = { manhattan: 'mnh', harlem: 'mnh', upper_manhattan: 'mnh', brooklyn: 'brk', queens: 'que' };
      const clArea = clAreaMap[area] || 'mnh';
      const hpAreaMap = { manhattan: 'manhattan-new-york-ny', brooklyn: 'brooklyn-ny', queens: 'queens-ny' };
      const hpArea = hpAreaMap[area] || hpAreaMap['manhattan'];
      const cityMap = { manhattan: 'manhattan-ny', brooklyn: 'brooklyn-ny', queens: 'queens-ny' };
      const cityGeneric = 'new-york-ny';
      const citySlug = cityMap[area] || cityGeneric;
      const rlAreaMap = { manhattan: 'Manhattan_NY', harlem: 'Manhattan_NY', upper_manhattan: 'Manhattan_NY', brooklyn: 'Brooklyn_NY', queens: 'Queens_NY' };
      const rlArea = rlAreaMap[area] || 'Manhattan_NY';
      return { seArea, zlArea, clArea, hpArea, citySlug, rlArea };
    }
    const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // ===== Stato & UI =====
    function readState(){
      const area = document.getElementById('area').value;
      const maxRent = Math.max(0, parseInt(document.getElementById('maxRent').value || '3000', 10));
      const bedsMin = document.getElementById('bedsMin').value;
      const zip = (document.getElementById('zip').value || '').trim();
      const noFee = document.getElementById('noFee').checked;
      const leaseTakeover = document.getElementById('leaseTakeover').checked;
      const directOwner = document.getElementById('directOwner').checked;
      const corpAssignable = document.getElementById('corpAssignable').checked;
      return { area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner, corpAssignable };
    }
    function updateLabels(){
      const { area, maxRent } = readState();
      document.getElementById('maxRentLabel').textContent = fmt.format(maxRent);
      const areaName = area === 'upper_manhattan' ? 'Upper Manhattan' : (area.charAt(0).toUpperCase()+area.slice(1)).replace('_',' ');
      document.getElementById('areaLabel').textContent = areaName;
      document.getElementById('nabeAreaLabel').textContent = areaName;
    }

    // Beds segmented
    (function initBedsSeg(){
      const seg = document.getElementById('bedsSeg');
      const hidden = document.getElementById('bedsMin');
      const setActive = (val)=>{
        hidden.value = val;
        [...seg.querySelectorAll('.beds-btn')].forEach(b=>{
          const on = (b.dataset.beds === val);
          b.classList.toggle('beds-active', on);
          b.setAttribute('aria-pressed', on ? 'true' : 'false');
        });
      };
      seg.addEventListener('click', (e)=>{
        const b = e.target.closest('.beds-btn[data-beds]');
        if (!b) return;
        setActive(b.dataset.beds);
        buildProviderCards();
      });
      setActive(hidden.value || '');
    })();

    // Quartieri pills
    function renderNabePills(){
      const box = document.getElementById('nabePills');
      const { area } = readState();
      const currentZip = document.getElementById('zip').value;
      box.innerHTML = '';
      (NABES[area] || []).forEach(({name, zip})=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = name;
        btn.className = 'chip';
        if (currentZip === zip) btn.classList.add('chip-active');
        btn.onclick = () => {
          const input = document.getElementById('zip');
          input.value = (input.value === zip) ? '' : zip; // toggle
          renderNabePills();
          buildProviderCards();
        };
        box.appendChild(btn);
      });
    }

    // Provider URLs (6 sorgenti)
    function getProviderLinks({ area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner, corpAssignable }){
      const enc = encodeURIComponent;
      const bedsParam = bedsMin ? bedsMin : '';
      const { seArea, zlArea, clArea, hpArea, citySlug, rlArea } = getAreaSlugs(area);
      const qTerms = buildQueryTerms(leaseTakeover, directOwner, corpAssignable);    // SE/Zillow
      const simpleCL = buildSimpleTerms(leaseTakeover, directOwner, corpAssignable); // Craigslist

      // StreetEasy
      let se = `https://streeteasy.com/for-rent/${seArea}?max_price=${maxRent}`;
      if (bedsParam) se += `&beds=${bedsParam}`;
      if (noFee) se += `&no_fee=true`;
      if (zip) se += `&search=zip:${zip}`;
      if (qTerms) se += `&search=${enc(qTerms)}`;

      // Zillow
      let zl = `https://www.zillow.com/${zlArea}/rentals/?price=0-${maxRent}`;
      if (bedsParam) zl += `&beds=${bedsParam}-_`;
      if (zip) zl = `https://www.zillow.com/homes/for_rent/${zip}_rb/?price=0-${maxRent}`;
      if (qTerms && zip) zl += `&text=${enc(qTerms)}`;

      // HotPads
      let hp = `https://hotpads.com/${hpArea}/apartments-for-rent?price=-${maxRent}`;
      if (bedsParam) hp += `&beds=${bedsParam}`;
      if (zip) hp = `https://hotpads.com/${zip}/apartments-for-rent?price=-${maxRent}`;

      // Apartments.com
      let ap;
      if (zip) {
        ap = `https://www.apartments.com/apartments/${zip}/?max-price=${maxRent}`;
      } else {
        ap = `https://www.apartments.com/${citySlug}/?max-price=${maxRent}`;
      }
      if (bedsParam) ap += `&beds=${bedsParam}`;

      // Realtor.com
      let re = `https://www.realtor.com/apartments/${rlArea}/price-na-${maxRent}`;
      if (bedsParam) re += `/beds-${bedsParam}`;
      if (zip) re = `https://www.realtor.com/apartments/${zip}/price-na-${maxRent}`;
      if (noFee) re += (re.includes('?') ? '&' : '?') + 'keyword=no+fee';

      // Craigslist — ZIP via postal + search_distance, query semplice
      const clParams = new URLSearchParams();
      clParams.set('max_price', String(maxRent));
      if (bedsParam) clParams.set('min_bedrooms', String(bedsParam));
      if (zip){ clParams.set('postal', zip); clParams.set('search_distance', '2'); }
      if (simpleCL) clParams.set('query', simpleCL);
      const cl = `https://newyork.craigslist.org/search/${clArea}/apa?${clParams.toString()}`;

      return [
        { name: 'HotPads',        url: hp },
        { name: area==='manhattan' ? 'Craigslist (Manhattan)' : area==='brooklyn' ? 'Craigslist (Brooklyn)' : 'Craigslist (Queens)', url: cl },
        { name: 'StreetEasy',     url: se },
        { name: 'Zillow',         url: zl },
        { name: 'Apartments.com', url: ap },
        { name: 'Realtor.com',    url: re },
      ];
    }

    function buildProviderCards(){
      const { area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner, corpAssignable } = readState();
      const p = document.getElementById('providers');
      p.innerHTML = '';

      const providers = getProviderLinks({ area, maxRent, bedsMin, zip, noFee, leaseTakeover, directOwner, corpAssignable });
      providers.forEach(pr => {
        const a = document.createElement('a');
        a.href = pr.url; a.target = '_blank'; a.rel = 'noopener';
        a.className = 'card block border border-muted rounded-2xl bg-surface p-4';
        a.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${pr.name}</h3>
            <span class="inline-flex items-center gap-1 text-sm text-muted">
              apri
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-70">
                <path d="M7 17L17 7M17 7H9M17 7v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </div>
          <p class="text-sm text-muted">
            Filtri: ${areaLabelText()} · max ${fmt.format(maxRent)}${zip?` · ${zipToNabe(zip) || ('ZIP '+zip)}`:''}${bedsMin?` · ${bedsMin}+ letti`:''}${noFee?` · no-fee`:''}${leaseTakeover?` · lease takeover`:''}${directOwner?` · direct owner`:''}${corpAssignable?` · corporate/assignable`:''}
          </p>`;
        p.appendChild(a);
      });

      // share url
      const params = new URLSearchParams();
      params.set('area', area);
      params.set('max', String(maxRent));
      if (bedsMin) params.set('beds', bedsMin);
      if (zip) params.set('zip', zip);
      if (noFee) params.set('nofee', '1');
      if (leaseTakeover) params.set('lt', '1');
      if (directOwner) params.set('do', '1');
      if (corpAssignable) params.set('ca', '1');
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
    }

    function areaLabelText(){
      const val = document.getElementById('area').value;
      return val === 'upper_manhattan' ? 'Upper Manhattan' : (val.charAt(0).toUpperCase()+val.slice(1)).replace('_',' ');
    }
    function zipToNabe(zip){
      for (const area in NABES){
        const hit = NABES[area].find(n=>n.zip===zip);
        if (hit) return hit.name;
      }
      return null;
    }

    // ===== Strict (serverless)
    const API_BASE = 'https://rent-finder-manhattan.vercel.app';

    // Regex contatti (title-based, no scraping)
    const mailRe = /[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig;
    const phoneRe = /(?:(?:\+1[\s-]?)?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4})/g;

    function extractContactsFromTitle(title){
      const emails = (title.match(mailRe)||[]).slice(0,2);
      const phones = (title.match(phoneRe)||[]).slice(0,2);
      return { emails, phones };
    }

    async function loadStrict(){
      const { area, maxRent, bedsMin, zip, leaseTakeover, directOwner, corpAssignable } = readState();
      const box = document.getElementById('strictBox');

      const allowed = ['manhattan', 'brooklyn', 'queens', 'harlem', 'upper_manhattan'];
      if (!allowed.includes(area)) {
        box.innerHTML = '<div class="text-sm text-muted">Strict non disponibile per quest’area.</div>';
        return;
      }

      const params = new URLSearchParams({ max: String(maxRent) });
      params.set('area', area);
      if (bedsMin) params.set('beds', String(bedsMin));
      if (zip) params.set('zip', zip);

      const qTerms = buildQueryTerms(leaseTakeover, directOwner, corpAssignable);
      if (qTerms) params.set('q', qTerms);

      box.innerHTML = '<div class="text-sm text-muted">Caricamento…</div>';
      try {
        const res = await fetch(`${API_BASE}/api/listings?${params.toString()}`);
        const json = await res.json();
        box.innerHTML = '';
        if (!json.data || !json.data.length){
          box.innerHTML = '<div class="text-sm text-muted">Nessun risultato ≤ $3.000 con questi filtri.</div>';
          return;
        }
        json.data.forEach(l => {
          const { emails, phones } = extractContactsFromTitle(l.title || '');
          const a = document.createElement('div');
          a.className = 'card border border-muted rounded-2xl bg-surface p-4';
          a.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <a href="${l.url}" target="_blank" rel="noopener" class="font-semibold hover:underline block truncate">${l.title || 'Listing'}</a>
                <div class="text-sm text-muted mt-1 flex flex-wrap items-center gap-2">
                  <span class="badge">$${l.price || ''}</span>
                  <span class="badge">ZIP ${l.zipcode || '—'}</span>
                  <span class="badge">Craigslist</span>
                </div>
                <div class="text-xs text-muted mt-2">
                  ${ (emails.length || phones.length)
                    ? `Contatti rilevati: ${[...emails, ...phones].join(' · ')}`
                    : `Apri l’annuncio per contatti/management.` }
                </div>
              </div>
              <div class="flex flex-col items-end gap-2 shrink-0">
                <a href="${l.url}" target="_blank" rel="noopener" class="text-sm px-3 py-1 rounded border border-muted hover:border-white/50">Apri</a>
                <button class="text-sm px-3 py-1 rounded bg-[var(--accent)] hover:bg-[var(--accent-700)] text-white" data-save="1">Salva</button>
              </div>
            </div>
          `;
          // salva handler
          a.querySelector('[data-save]').addEventListener('click', ()=>{
            saveOpportunity({
              title: l.title || 'Listing',
              url: l.url,
              price: l.price || null,
              zipcode: l.zipcode || null,
              contacts: { emails, phones },
              flags: { leaseTakeover, directOwner, corpAssignable },
              at: Date.now()
            });
          });
          box.appendChild(a);
        });
      } catch (e) {
        box.innerHTML = '<div class="text-sm text-red-500">Errore nel caricamento.</div>';
      }
    }

    // ===== Saved opportunities (local)
    function saveOpportunity(op){
      const key = 'lease_opps';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.unshift(op);
      localStorage.setItem(key, JSON.stringify(arr.slice(0, 60)));
      renderSaved();
    }
    function deleteOpportunity(idx){
      const key = 'lease_opps';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.splice(idx,1);
      localStorage.setItem(key, JSON.stringify(arr));
      renderSaved();
    }
    function renderSaved(){
      const key = 'lease_opps';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      const grid = document.getElementById('savedBox');
      const empty = document.getElementById('savedEmpty');
      grid.innerHTML = '';
      if (!arr.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      arr.forEach((op,idx)=>{
        const d = new Date(op.at);
        const div = document.createElement('div');
        div.className = 'card border border-muted rounded-2xl bg-surface p-4';
        const tags = [];
        if (op.flags?.leaseTakeover) tags.push('lease takeover');
        if (op.flags?.directOwner) tags.push('direct owner');
        if (op.flags?.corpAssignable) tags.push('corp/assignable');
        const contactLine = (op.contacts?.emails?.length || op.contacts?.phones?.length)
          ? [...(op.contacts.emails||[]), ...(op.contacts.phones||[])].join(' · ')
          : '—';
        div.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <a href="${op.url}" target="_blank" rel="noopener" class="font-semibold hover:underline block truncate">${op.title}</a>
              <div class="text-sm text-muted mt-1 flex flex-wrap items-center gap-2">
                ${op.price?`<span class="badge">$${op.price}</span>`:''}
                ${op.zipcode?`<span class="badge">ZIP ${op.zipcode}</span>`:''}
                ${tags.length?`<span class="badge">${tags.join(' · ')}</span>`:''}
              </div>
              <div class="text-xs text-muted mt-2">Contatti: ${contactLine}</div>
              <div class="text-xs text-muted mt-1">${d.toLocaleString()}</div>
            </div>
            <div class="flex flex-col items-end gap-2 shrink-0">
              <a href="${op.url}" target="_blank" rel="noopener" class="text-sm px-3 py-1 rounded border border-muted hover:border-white/50">Apri</a>
              <button class="text-sm px-3 py-1 rounded border border-muted hover:border-white/50" data-del="${idx}">Elimina</button>
            </div>
          </div>
        `;
        div.querySelector(`[data-del="${idx}"]`).addEventListener('click', ()=> deleteOpportunity(idx));
        grid.appendChild(div);
      });
    }

    // ===== Azioni
    document.getElementById('build').addEventListener('click', buildProviderCards);
    document.getElementById('strict').addEventListener('click', loadStrict);
    document.getElementById('reset').addEventListener('click', ()=>{
      document.getElementById('area').value = 'manhattan';
      document.getElementById('maxRent').value = 3000;
      document.getElementById('bedsMin').value = '';
      document.getElementById('zip').value = '';
      document.getElementById('noFee').checked = false;
      document.getElementById('leaseTakeover').checked = false;
      document.getElementById('directOwner').checked = false;
      document.getElementById('corpAssignable').checked = false;
      updateLabels(); renderNabePills(); buildProviderCards(); renderSaved();
    });
    document.getElementById('area').addEventListener('change', ()=>{
      document.getElementById('zip').value = '';
      updateLabels(); renderNabePills(); buildProviderCards();
    });
    document.getElementById('maxRent').addEventListener('input', updateLabels);
    document.getElementById('leaseTakeover').addEventListener('change', buildProviderCards);
    document.getElementById('directOwner').addEventListener('change', buildProviderCards);
    document.getElementById('corpAssignable').addEventListener('change', buildProviderCards);
    document.getElementById('clearNabe').addEventListener('click', ()=>{
      document.getElementById('zip').value = '';
      renderNabePills(); buildProviderCards();
    });
    document.getElementById('clearSaved').addEventListener('click', ()=>{
      localStorage.removeItem('lease_opps'); renderSaved();
    });

    // ===== Init
    (function initFromQuery(){
      const u = new URL(location.href);
      const area = u.searchParams.get('area');
      const max = u.searchParams.get('max');
      const beds = u.searchParams.get('beds');
      const zip = u.searchParams.get('zip');
      const nofee = u.searchParams.get('nofee');
      const lt = u.searchParams.get('lt');
      const dO = u.searchParams.get('do');
      const ca = u.searchParams.get('ca');

      if (area && document.querySelector(`#area option[value="${area}"]`)) document.getElementById('area').value = area;
      if (max) document.getElementById('maxRent').value = max;
      if (beds) document.getElementById('bedsMin').value = beds;
      if (zip) document.getElementById('zip').value = zip;
      if (nofee) document.getElementById('noFee').checked = true;
      if (lt) document.getElementById('leaseTakeover').checked = true;
      if (dO) document.getElementById('directOwner').checked = true;
      if (ca) document.getElementById('corpAssignable').checked = true;

      updateLabels(); renderNabePills(); buildProviderCards(); renderSaved();

      // sync pulsanti letti
      const seg = document.getElementById('bedsSeg');
      [...seg.children].forEach(b=>b.classList.toggle('beds-active', b.dataset.beds === (beds||'')));
    })();
  </script>
</body>
</html>
