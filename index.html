<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affitti a Manhattan ≤ $3.000</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Trova rapidamente affitti a Manhattan entro 3000$ con link diretti ai principali portali." />
  <style>
    .card:hover{ box-shadow: 0 8px 24px rgba(0,0,0,.12);} 
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl md:text-4xl font-bold">Affitti a Manhattan ≤ <span id="maxRentLabel">$3,000</span></h1>
      <p class="text-sm text-gray-600 mt-1">Pagina statica, nessuno scraping: genera <strong>link diretti</strong> con filtri precompilati su StreetEasy, Zillow, RentHop, Craigslist e Realtor. I portali potrebbero richiedere un clic aggiuntivo per applicare tutti i filtri.</p>
    </header>

    <!-- Controls -->
    <section class="grid md:grid-cols-5 gap-3 items-end mb-6">
      <div class="md:col-span-1">
        <label class="block text-sm font-medium mb-1" for="maxRent">Budget massimo ($)</label>
        <input id="maxRent" type="number" inputmode="numeric" value="3000" min="1000" step="50"
               class="w-full border rounded-2xl p-3 bg-white" />
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium mb-1" for="bedsMin">Letti min</label>
        <select id="bedsMin" class="w-full border rounded-2xl p-3 bg-white">
          <option value="">Qualsiasi</option>
          <option value="0">Studio</option>
          <option value="1">1+</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
        </select>
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium mb-1" for="zip">ZIP (opzionale)</label>
        <input id="zip" placeholder="es. 10009" class="w-full border rounded-2xl p-3 bg-white" />
      </div>
      <div class="md:col-span-1 flex items-center gap-2">
        <input id="noFee" type="checkbox" class="w-5 h-5" />
        <label for="noFee" class="text-sm font-medium">No-fee (se disponibile)</label>
      </div>
      <div class="md:col-span-1 flex gap-2">
        <button id="build" class="flex-1 rounded-2xl px-4 py-3 bg-black text-white">Genera link</button>
        <button id="strict" class="flex-1 rounded-2xl px-4 py-3 bg-green-600 text-white" title="Mostra solo risultati ≤ $3.000 filtrati lato server">Strict ≤$3k</button>
        <button id="save" class="rounded-2xl px-4 py-3 border">Salva</button>
      </div>
    </section>

    <!-- Quick ZIP pills -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">ZIP Manhattan rapidi</h2>
      <div id="zipPills" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Results (link-out) -->
    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="providers"></section>

    <!-- Strict results (server-filtered) -->
    <section class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Risultati filtrati (serverless, ≤ $3.000)</h2>
      <div id="strictBox" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p class="text-xs text-gray-500 mt-2">
        Questa sezione mostra solo annunci ≤ $3.000 a Manhattan (es. Craigslist RSS), filtrati lato server.
      </p>
    </section>

    <section class="mt-10">
      <h2 class="text-lg font-semibold mb-2">Ricerche salvate (locale)</h2>
      <div id="saved" class="grid md:grid-cols-3 gap-3"></div>
    </section>

    <footer class="mt-12 text-xs text-gray-500">
      <p>Nota: questa pagina non fa scraping e non usa API dei portali. Apre solo ricerche pubbliche con parametri nell'URL. I parametri dei portali possono cambiare nel tempo.</p>
    </footer>
  </main>

  <script>
    // ... [tutto il codice esistente invariato qui sopra] ...

    // ===== Strict mode (serverless) =====
    // Se la pagina è su Vercel, lascia vuoto:
    const API_BASE = '';
    // Se la pagina è su GitHub Pages e l’API è su Vercel, usa il dominio Vercel:
    // const API_BASE = 'https://rent-finder-manhattan.vercel.app';

    async function loadStrict(){
      const maxRent = document.getElementById('maxRent').value || 3000;
      const bedsMin = document.getElementById('bedsMin').value || '';
      const zip = (document.getElementById('zip').value || '').trim();

      const params = new URLSearchParams({ max: String(maxRent) });
      if (bedsMin) params.set('beds', bedsMin);
      if (zip) params.set('zip', zip);

      const box = document.getElementById('strictBox');
      box.innerHTML = '<div class="text-sm text-gray-600">Caricamento…</div>';

      try {
        const res = await fetch(`${API_BASE}/api/listings?${params.toString()}`);
        const json = await res.json();
        box.innerHTML = '';
        if (!json.data || !json.data.length) {
          box.innerHTML = '<div class="text-sm text-gray-500">Nessun risultato ≤ $3.000 con questi filtri.</div>';
          return;
        }
        json.data.forEach(l => {
          const a = document.createElement('a');
          a.href = l.url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'block border rounded-2xl bg-white p-4';
          a.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <div class="font-semibold truncate pr-2">${l.title || 'Listing'}</div>
              <span class="text-sm">$${l.price || ''}</span>
            </div>
            <div class="text-sm text-gray-600">ZIP ${l.zipcode || '—'}</div>
            <div class="text-xs text-gray-500 mt-1">Fonte: Craigslist</div>
          `;
          box.appendChild(a);
        });
      } catch (e) {
        box.innerHTML = '<div class="text-sm text-red-600">Errore nel caricamento.</div>';
      }
    }

    document.getElementById('strict').addEventListener('click', loadStrict);
  </script>
</body>
</html>
